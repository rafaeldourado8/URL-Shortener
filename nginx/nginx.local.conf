events {
    worker_connections 1024;
}

http {
    upstream backend {
        server app:8000;
    }

    upstream frontend {
        server frontend:5173;
    }

    server {
        listen 80;
        server_name localhost;

        # ---------------------------------------------------
        # 1. Configuração Específica para VITE (HMR / WebSocket)
        # ---------------------------------------------------
        # O Vite usa essa rota para notificar mudanças de arquivo
        location /@vite/client {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
        
        # Rotas de assets do frontend (node_modules, src, etc)
        location /node_modules/ {
            proxy_pass http://frontend;
        }
        location /src/ {
            proxy_pass http://frontend;
        }

        # ---------------------------------------------------
        # 2. Rotas Explicitas do Backend (API)
        # ---------------------------------------------------
        location /shorten {
            proxy_pass http://backend;
        }

        location /docs {
            proxy_pass http://backend;
        }

        location /openapi.json {
            proxy_pass http://backend;
        }

        # ---------------------------------------------------
        # 3. Regra Mágica: URL Curta vs Rota Frontend
        # ---------------------------------------------------
        # Se a URL tiver entre 1 e 10 caracteres alfanuméricos (ex: /aB3, /Xy99)
        # Assumimos que é um LINK ENCURTADO e mandamos pro Backend.
        # CUIDADO: Não crie rotas no Frontend como /login ou /about com menos de 10 chars
        # ou ajuste essa Regex.
        location ~ ^/[a-zA-Z0-9]{1,10}$ {
             proxy_pass http://backend;
        }

        # ---------------------------------------------------
        # 4. Frontend (Default / Catch-All)
        # ---------------------------------------------------
        # Qualquer coisa que não bateu nas regras acima vai pro React.
        location / {
            proxy_pass http://frontend;
            
            # Necessário para Websockets do Vite funcionarem na raiz também
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
        }
    }
}