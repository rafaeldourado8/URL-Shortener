.PHONY: help setup dev prod test clean deploy-backend deploy-frontend check

# VariÃ¡veis
DOCKER_COMPOSE = docker-compose
DOCKER_COMPOSE_PROD = docker-compose -f docker-compose.prod.yml
BACKEND_DIR = backend
FRONTEND_DIR = frontend
TERRAFORM_DIR = infrastructure/terraform

help: ## Mostra esta mensagem de ajuda
	@echo "URL Shortener - Comandos DisponÃ­veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## ConfiguraÃ§Ã£o inicial do projeto
	@echo "ðŸ”§ Configurando projeto..."
	@cp -n $(BACKEND_DIR)/.env.example $(BACKEND_DIR)/.env || true
	@echo "âœ… .env criado (configure as variÃ¡veis)"
	@cd $(FRONTEND_DIR) && npm install
	@echo "âœ… DependÃªncias do frontend instaladas"
	@cd $(BACKEND_DIR) && pip install -r requirements.txt
	@echo "âœ… DependÃªncias do backend instaladas"
	@chmod +x scripts/*.sh
	@echo "âœ… Scripts executÃ¡veis"
	@echo ""
	@echo "ðŸ“‹ PrÃ³ximos passos:"
	@echo "1. Edite backend/.env com suas configuraÃ§Ãµes"
	@echo "2. Execute: make dev"

check: ## Verifica erros no projeto
	@echo "ðŸ” Verificando erros..."
	@./scripts/check-errors.sh

dev: ## Inicia ambiente de desenvolvimento
	@echo "ðŸš€ Iniciando ambiente de desenvolvimento..."
	$(DOCKER_COMPOSE) up -d
	@echo ""
	@echo "âœ… ServiÃ§os iniciados!"
	@echo "ðŸ“± Frontend: http://localhost"
	@echo "ðŸ”Œ Backend API: http://localhost:8000/docs"
	@echo "ðŸ’¾ Redis: localhost:6379"
	@echo ""
	@echo "ðŸ“Š Para ver logs: make logs"
	@echo "ðŸ›‘ Para parar: make down"

prod: ## Inicia ambiente de produÃ§Ã£o
	@echo "ðŸ­ Iniciando ambiente de produÃ§Ã£o..."
	$(DOCKER_COMPOSE_PROD) up -d
	@echo "âœ… Ambiente de produÃ§Ã£o iniciado!"

down: ## Para todos os containers
	@echo "ðŸ›‘ Parando containers..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… Containers parados"

restart: ## Reinicia todos os containers
	@echo "ðŸ”„ Reiniciando containers..."
	$(DOCKER_COMPOSE) restart
	@echo "âœ… Containers reiniciados"

logs: ## Mostra logs de todos os serviÃ§os
	$(DOCKER_COMPOSE) logs -f

logs-backend: ## Mostra logs do backend
	$(DOCKER_COMPOSE) logs -f app

logs-frontend: ## Mostra logs do frontend
	$(DOCKER_COMPOSE) logs -f frontend

logs-nginx: ## Mostra logs do nginx
	$(DOCKER_COMPOSE) logs -f nginx

ps: ## Lista containers em execuÃ§Ã£o
	$(DOCKER_COMPOSE) ps

shell-backend: ## Acessa shell do container backend
	$(DOCKER_COMPOSE) exec app bash

shell-frontend: ## Acessa shell do container frontend
	$(DOCKER_COMPOSE) exec frontend sh

shell-db: ## Acessa shell do PostgreSQL
	$(DOCKER_COMPOSE) exec db_master psql -U user -d shortener_db

shell-redis: ## Acessa shell do Redis
	$(DOCKER_COMPOSE) exec redis redis-cli

test: ## Executa testes do backend
	@echo "ðŸ§ª Executando testes..."
	cd $(BACKEND_DIR) && pytest -v --cov=app --cov-report=html

test-watch: ## Executa testes em modo watch
	cd $(BACKEND_DIR) && pytest-watch

lint: ## Executa linter no cÃ³digo
	@echo "ðŸ” Executando linter..."
	cd $(BACKEND_DIR) && pylint app/
	cd $(FRONTEND_DIR) && npm run lint

format: ## Formata cÃ³digo
	@echo "âœ¨ Formatando cÃ³digo..."
	cd $(BACKEND_DIR) && black app/
	cd $(FRONTEND_DIR) && npm run format || true
	cd $(TERRAFORM_DIR) && terraform fmt

migrate: ## Executa migraÃ§Ãµes do banco
	@echo "ðŸ“Š Executando migraÃ§Ãµes..."
	$(DOCKER_COMPOSE) exec app alembic upgrade head

migrate-create: ## Cria nova migraÃ§Ã£o (use MSG="descriÃ§Ã£o")
	@echo "ðŸ“ Criando migraÃ§Ã£o: $(MSG)"
	$(DOCKER_COMPOSE) exec app alembic revision --autogenerate -m "$(MSG)"

migrate-downgrade: ## Reverte Ãºltima migraÃ§Ã£o
	@echo "â†©ï¸  Revertendo migraÃ§Ã£o..."
	$(DOCKER_COMPOSE) exec app alembic downgrade -1

build: ## Builda imagens Docker
	@echo "ðŸ—ï¸  Buildando imagens..."
	$(DOCKER_COMPOSE) build

build-prod: ## Builda imagens para produÃ§Ã£o
	@echo "ðŸ­ Buildando imagens de produÃ§Ã£o..."
	$(DOCKER_COMPOSE_PROD) build

clean: ## Remove containers, volumes e imagens
	@echo "ðŸ§¹ Limpando containers, volumes e imagens..."
	$(DOCKER_COMPOSE) down -v --rmi all
	@echo "âœ… Limpeza concluÃ­da"

clean-cache: ## Remove cache do Docker
	@echo "ðŸ§¹ Removendo cache do Docker..."
	docker system prune -af
	@echo "âœ… Cache removido"

# Terraform
tf-init: ## Inicializa Terraform
	@echo "ðŸ—ï¸  Inicializando Terraform..."
	cd $(TERRAFORM_DIR) && terraform init

tf-plan: ## Planeja mudanÃ§as no Terraform
	@echo "ðŸ“‹ Planejando mudanÃ§as..."
	cd $(TERRAFORM_DIR) && terraform plan

tf-apply: ## Aplica mudanÃ§as no Terraform
	@echo "ðŸš€ Aplicando mudanÃ§as..."
	cd $(TERRAFORM_DIR) && terraform apply

tf-destroy: ## Destroi recursos do Terraform (CUIDADO!)
	@echo "âš ï¸  ATENÃ‡ÃƒO: Isso vai DESTRUIR todos os recursos!"
	@read -p "Tem certeza? (yes/no): " confirm && [ "$$confirm" = "yes" ] || exit 1
	cd $(TERRAFORM_DIR) && terraform destroy

tf-output: ## Mostra outputs do Terraform
	cd $(TERRAFORM_DIR) && terraform output

# Deploy
deploy-backend: ## Deploy do backend via GitHub Actions
	@echo "ðŸš€ Fazendo deploy do backend..."
	git add backend/
	git commit -m "Deploy backend" || true
	git push origin main
	@echo "âœ… Deploy iniciado! Acompanhe em GitHub Actions"

deploy-frontend: ## Deploy do frontend via GitHub Actions
	@echo "ðŸš€ Fazendo deploy do frontend..."
	git add frontend/
	git commit -m "Deploy frontend" || true
	git push origin main
	@echo "âœ… Deploy iniciado! Acompanhe em GitHub Actions"

deploy-all: ## Deploy completo (backend + frontend)
	@echo "ðŸš€ Fazendo deploy completo..."
	git add .
	git commit -m "Deploy: backend + frontend" || true
	git push origin main
	@echo "âœ… Deploy iniciado! Acompanhe em GitHub Actions"

# UtilitÃ¡rios
secrets: ## Configura secrets do GitHub
	@./scripts/setup-github-secrets.sh

benchmark: ## Executa benchmark de performance
	@echo "ðŸ“Š Executando benchmark..."
	@echo "Criar URL:"
	ab -n 1000 -c 10 -p tests/post.json -T application/json http://localhost/shorten
	@echo ""
	@echo "Redirecionar (apÃ³s criar uma URL):"
	@echo "ab -n 10000 -c 100 http://localhost/abc123"

health: ## Verifica health dos serviÃ§os
	@echo "ðŸ¥ Verificando saÃºde dos serviÃ§os..."
	@curl -f http://localhost/health && echo "âœ… Backend OK" || echo "âŒ Backend FALHOU"
	@curl -f http://localhost && echo "âœ… Frontend OK" || echo "âŒ Frontend FALHOU"

db-backup: ## Faz backup do banco de dados
	@echo "ðŸ’¾ Fazendo backup do banco..."
	$(DOCKER_COMPOSE) exec -T db_master pg_dump -U user shortener_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup criado: backup_$(shell date +%Y%m%d_%H%M%S).sql"

db-restore: ## Restaura backup do banco (use FILE=backup.sql)
	@echo "ðŸ“¥ Restaurando backup: $(FILE)"
	$(DOCKER_COMPOSE) exec -T db_master psql -U user shortener_db < $(FILE)
	@echo "âœ… Backup restaurado"

stats: ## Mostra estatÃ­sticas dos containers
	@echo "ðŸ“Š EstatÃ­sticas dos containers:"
	docker stats --no-stream